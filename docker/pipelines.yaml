# OpenSearch Data Prepper Pipeline Configuration
# Data Prepper 2.12.0 - Corrected configuration

# ============================================================================
# Entry Point: OTLP receiver for traces
# ============================================================================
entry-pipeline:
  source:
    otel_trace_source:
      ssl: false
      port: 21891
  buffer:
    bounded_blocking:
      buffer_size: 1024
      batch_size: 256
  sink:
    - pipeline:
        name: "trace-pipeline"
    - pipeline:
        name: "raw-pipeline"
    - pipeline:
        name: "service-map-pipeline"

# ============================================================================
# Trace Pipeline: OpenSearch Trace Analytics format
# ============================================================================
trace-pipeline:
  source:
    pipeline:
      name: "entry-pipeline"
  processor:
    - otel_traces:  # Updated from otel_trace_raw
  sink:
    - opensearch:
        hosts: ["http://opensearch:9200"]
        insecure: true
        index_type: trace-analytics-raw

# ============================================================================
# Raw Pipeline: Store raw span data
# ============================================================================
raw-pipeline:
  source:
    pipeline:
      name: "entry-pipeline"
  sink:
    - opensearch:
        hosts: ["http://opensearch:9200"]
        insecure: true
        index_type: custom
        index: "otel-spans-%{yyyy.MM.dd}"

# ============================================================================
# Service Map Pipeline: Generate service relationships
# ============================================================================
service-map-pipeline:
  source:
    pipeline:
      name: "entry-pipeline"
  processor:
    - service_map:  # Updated from service_map_stateful
  sink:
    - opensearch:
        hosts: ["http://opensearch:9200"]
        insecure: true
        index_type: trace-analytics-service-map

# ============================================================================
# Logs Pipeline: OTLP logs (CORRECTED - removed unauthenticated)
# ============================================================================
log-pipeline:
  source:
    otel_logs_source:
      ssl: false
      port: 21892
      # NO unauthenticated parameter - it doesn't exist!
  buffer:
    bounded_blocking:
      buffer_size: 512
      batch_size: 256
  sink:
    - opensearch:
        hosts: ["http://opensearch:9200"]
        insecure: true
        index_type: custom
        index: "ss4o_logs-%{yyyy.MM.dd}"

# ============================================================================
# Metrics Pipeline: OTLP metrics (CORRECTED - removed unauthenticated)
# ============================================================================
metrics-pipeline:
  source:
    otel_metrics_source:
      ssl: false
      port: 21893
      # NO unauthenticated parameter - it doesn't exist!
  buffer:
    bounded_blocking:
      buffer_size: 512
      batch_size: 256
  processor:
    - otel_metrics:
        calculate_histogram_buckets: true
        calculate_exponential_histogram_buckets: true
        exponential_histogram_max_allowed_scale: 10
  sink:
    - opensearch:
        hosts: ["http://opensearch:9200"]
        insecure: true
        index_type: custom
        index: "ss4o_metrics-%{yyyy.MM.dd}"
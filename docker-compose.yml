services:
  nats:
    image: nats:latest
    command: "-n newton -DV -m 8222 -p 4222"
    hostname: nats-server
    ports:
      - "8222:8222"  # Monitoring port
      - "4222:4222"  # Client connection port
    networks:
      - aiori-net

#  nats-ui:
#    image: mdawar/nats-dashboard:latest
#    container_name: natsui
#    environment:
#      REVERSE_PROXY_UPSTREAM: 'http://nats-server:8222'  # Connect to NATS monitoring
#    ports:
#      - "9222:80"  # Dashboard access port
#    depends_on:
#      - nats
#    networks:
#      - aiori-net

#  nui:
#    image: ghcr.io/nats-nui/nui:edge
#    volumes:
#     - ./db:/db
#    ports:
#     - "31312:31311" 
#    depends_on:
#     - nats
#    networks:
#      - aiori-net

#  otel-collector:
#    image: otel/opentelemetry-collector:0.92.0
#    command: ["--config=/etc/otel-collector-config.yaml"]
#    volumes:
#      - ./otel-collector-config.yaml:/etc/otel-collector-config.yaml
#    ports:
#      - "5081:5081"  # OTLP gRPC receiver (matches the port agents are trying to connect to)
#      - "4317:4317"  # OTLP gRPC receiver (alternative)
#      - "4318:4318"  # OTLP HTTP receiver
#    depends_on:
#      - nats
#    networks:
#      - aiori-net

  server:
    build:
      context: .
      dockerfile: docker/Dockerfile.server
    container_name: server
    ports:
      - "8000:8000"  # Server API
    depends_on:
      - nats
    networks:
      - aiori-net
    environment:
      - NATS_URL=nats://nats-server:4222

  agent_1:
    build:
      context: .
      dockerfile: docker/Dockerfile.agent
    container_name: agent_1
    volumes:
      - ./:/app
    environment:
      - NATS_URL=nats://nats-server:4222
      - AGENT_NAME=aiori_1
#      - OTLP_TRACE_ENDPOINT=otel-collector:5081
#      - OTLP_LOGS_ENDPOINT=otel-collector:5081
    ports:
      - "9101:9101"  # Agent metrics/API
    depends_on:
      - nats
      - server
#      - otel-collector
    networks:
      - aiori-net
    working_dir: /app  # Ensure correct working directory

  agent_2:
    build:
      context: .
      dockerfile: docker/Dockerfile.agent
    container_name: agent_2
    volumes:
      - ./:/app
    environment:
      - NATS_URL=nats://nats-server:4222
      - AGENT_NAME=aiori_2
#      - OTLP_TRACE_ENDPOINT=otel-collector:5081
#      - OTLP_LOGS_ENDPOINT=otel-collector:5081
    ports:
      - "9102:9102"  # Changed port to avoid conflict
    depends_on:
      - nats
      - server
#      - otel-collector
    networks:
      - aiori-net
    working_dir: /app

networks:
  aiori-net:
    driver: bridge
